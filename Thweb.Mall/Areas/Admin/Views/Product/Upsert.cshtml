@model ProductVm;
@{
    Layout = "/Views/Shared/_Layout_admin.cshtml";


    
}
<div class="container w-full p-10">
    <form method="post" asp-action="Upsert" enctype="multipart/form-data" id="myFrom">

        @if (Model == null)
        {
            <p class="text-center text-2xl">카테고리 추가</p>
        }
        else
        {
            <p class="text-center text-2xl">카테고리 수정</p>
            <input type="hidden" asp-for="Product.Id" />
        }

        <div class="my-4">
            
            <label asp-for="Product.Title"
                   class="block mb-2 text-base font-medium text-gray-900 dark:text-white">상품명 입력하세요.</label>
            <input asp-for="Product.Title"
                   class="th-input"
                   placeholder="상품명을 입력해주세요." />
        </div>

        <div class="my-4">
            <label asp-for="Product.Description"
                   class="block mb-2 text-base font-medium text-gray-900 dark:text-white">상품설명을 입력하세요.</label>
            <textarea asp-for="Product.Description"></textarea>
        </div>

        <div class="my-4">
            <label asp-for="Product.Price"
            class="block mb-2 text-base font-medium text-gray-900 dark:text-white">상품가격을 입력하세요.</label>
            <input asp-for="Product.Price"
                   class="th-input"
                   placeholder="상품 가격을 입력해주세요." />
        </div>

        <div class="my-4">
            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white" for="files">Upload file</label>
            <input 
                class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400" 
                aria-describedby="file_input_help"
                id="files" type="file" name="files" multiple />
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-300" id="file_input_help">SVG, PNG, JPG or GIF (MAX. 800x400px).</p>
        </div>

        
        @if (Model.Product != null)
        {

            <div class="my-4 flex w-full">

                @if (Model.Product.Images != null)
                {
                    foreach (var img in Model.Product.Images)
                    {
                        var imagePath = img.DirectoryPath + img.SaveFileName;
                        <div class="p-3 w-1/3 flex items-center justify-center">
                            <img src="@imagePath" alt="ProductImg" />
                        </div>

                    }
                
                }
             
            </div>

            <div class="flex w-full">


                @if (Model.Product.Images != null)
                {
                    foreach (var img in Model.Product.Images)
                    {
                        <div class="p-3 w-1/3 text-center">

                            <button type="button"
                                    onclick="Remove(@img.Id)"
                                    class="focus:outline-none text-white bg-yellow-400 hover:bg-yellow-500 focus:ring-4 focus:ring-yellow-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:focus:ring-yellow-900">
                                이미지 삭제
                            </button>
                        </div>
                    }

                }
            
            </div>
        }

        <div class="my-4">

            <label asp-for="Product.CategoryId" class="block mb-2 text-base font-medium text-gray-900 dark:text-white">카테고리를 선택하세요</label>
            <select 
                asp-for="Product.CategoryId"
                asp-items="@Model.CategoryList"
                class="
block w-full px-4 py-3 text-base text-gray-900 border border-gray-300 rounded-lg bg-gray-50 
focus:ring-blue-500 
focus:border-blue-500 
dark:bg-gray-700 
dark:border-gray-600 
dark:placeholder-gray-400 
dark:text-white 
dark:focus:ring-blue-500 
dark:focus:border-blue-500">
                <option disabled selected>Choose a country</option>
            </select>
            <span asp-validation-for="Product.CategoryId" class="text-red-500 text-sm p-4"></span>
        </div>

        @if (Model.Product == null)
        {
            <button class="th-bl-btn">추가</button>
        }
        else
        {
            <button class="th-bl-btn">수정</button>
        }
    </form>
</div>

@section Scripts {
    @await Html.PartialAsync("~/Views/Shared/_Partial/_SweetAlert.cshtml")

    <!-- Place the first <script> tag in your HTML's <head> -->
    <script src="https://cdn.tiny.cloud/1/ipga39m0e4iub3da2spb4imu9p4gc3w1yf36io9n0lsitrpf/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- Place the following <script> and <textarea> tags your HTML's <body> -->
    <script>
        
        tinymce.init({
            selector: 'textarea',
            plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
            toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap | removeformat',
            paste_data_images: true,
            images_upload_url: '/Admin/Product/ImageUpload',  // 서버의 이미지 업로드 URL
        });

        $("#myFrom").submit(function (e) {

            if (checkValue($("#Product_Title").val())) {
                e.preventDefault(); 
                alert('상품명을 입력해주세요.'); 
                return;
            }


            if (checkValue($("#Product_Title").val())) {
                e.preventDefault();
                alert('상품설명을 입력해주세요.'); 
                return;
            }


            if ($("#Product_Price").val() == 0) {
                e.preventDefault();
                alert('상품 가격을 입력해주세요.');
                return;
            }

            if (checkValue($("#Product_CategoryId").val())) {
                e.preventDefault();
                alert('카테고리를 선택해주세요.'); 
                return;
            }
    
        });

        function Remove(imageId) {
            $.ajax({
                type: 'POST',
                url: "/Admin/Product/RemoveImage",
                data: { imageId: imageId },
                success: function (response) {
                    console.log(response)
                    if (response.seccess) {
                        location.reload();
                    }
                },
                error: function (xhr, status, error) {
                    if (response.seccess) {
                        Swal.fire("삭제 중 에러가 발생했습니다. 잠시 후 다시 시도해주세요.");
                    }
                }
            });
        }

        $('#files').on('change', function (event) {
            const files = event.target.files;
            //이미지만 가능
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileType = file.type.toLowerCase();
                if (fileType.indexOf('image') === -1) {
                    alert('이미지 파일만 올릴 수 있습니다.');
                    $('#files').val(''); 
                    return;
                }
            }
            //최대 3개 제한
            if (files.length > 3) {
                alert('최대 파일 선택 수는 3개입니다.');
                $('#files').val(''); // Clear selected files
            }
        });
    </script>

}